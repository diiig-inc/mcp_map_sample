<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MAPS</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00897B',
                        'primary-dark': '#00695C',
                    }
                }
            }
        }
    </script>

    <!-- Vue.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>

    <!-- Map Libraries (ÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø) -->
    <div id="map-loader"></div>

    <style>
        /* „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #22c55e, #06b6d4);
        }
        .hover\:bg-gradient-primary-dark:hover {
            background: linear-gradient(135deg, #16a34a, #0891b2);
        }

        /* „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .typing-dot {
            animation: bounce 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* „Éû„ÉÉ„ÉóÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
            z-index: 0;
        }

        /* MapLibre/Mapbox„ÅÆ„Éû„Éº„Ç´„Éº */
        .maplibregl-marker,
        .mapboxgl-marker {
            cursor: pointer;
        }

        /* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .maplibregl-popup,
        .mapboxgl-popup {
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">
    <div id="app" class="h-screen flex flex-col">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="bg-white text-gray-800 h-16 flex items-center justify-between px-4 shadow-lg z-20 relative">
            <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
            <button
                @click="toggleSidebar"
                class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-lg transition-colors"
            >
                <span class="text-2xl leading-none text-gray-700">‚ò∞</span>
            </button>

            <!-- „É≠„Ç¥ -->
            <div class="flex items-center gap-2 text-base sm:text-lg font-semibold">
                <img src="img/icon.svg" alt="AI MAPS" class="h-8 w-8">
                <span class="hidden sm:inline">DIIIG Cloud Platform DEMO</span>
            </div>

            <!-- Âè≥ÂÅ¥„ÅÆ„Çπ„Éö„Éº„Çµ„Éº -->
            <div class="w-10"></div>
        </header>

        <!-- „Éû„ÉÉ„Éó„Ç≥„É≥„ÉÜ„Éä -->
        <div id="map"></div>

        <!-- „Çµ„Ç§„Éâ„Éê„Éº„É°„Éã„É•„Éº -->
        <div
            class="fixed top-0 left-0 h-full w-64 sm:w-72 bg-white shadow-2xl transform transition-transform duration-300 z-30"
            :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'"
        >
            <!-- „Çµ„Ç§„Éâ„Éê„Éº„Éò„ÉÉ„ÉÄ„Éº -->
            <div class="h-16 bg-gradient-primary text-white flex items-center justify-between px-4">
                <div class="flex items-center gap-2 font-semibold text-base">
                    <img src="img/icon.svg" alt="AI MAPS" class="h-8 w-8">
                    <span>AI MAPS</span>
                </div>
                <!-- Èñâ„Åò„Çã„Éú„Çø„É≥ÔºàÁµ±‰∏Ä„Çµ„Ç§„Ç∫Ôºâ -->
                <button
                    @click="toggleSidebar"
                    class="w-10 h-10 flex items-center justify-center hover:bg-white/20 rounded-lg transition-colors"
                >
                    <span class="text-xl leading-none">‚úï</span>
                </button>
            </div>

            <!-- „Çµ„Ç§„Éâ„Éê„Éº„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="p-4 space-y-4 h-[calc(100%-4rem)] overflow-y-auto">
                <!-- Êñ∞Ë¶è‰ΩúÊàê„Éú„Çø„É≥ -->
                <button
                    @click="createNewChat"
                    class="w-full h-12 bg-gradient-primary hover:bg-gradient-primary-dark text-white px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-md font-medium text-sm"
                >
                    <span class="text-lg leading-none">üóÇÔ∏è</span>
                    <span>„ÉÅ„É£„ÉÉ„Éà„ÇíÊñ∞Ë¶è‰ΩúÊàê</span>
                </button>

                <!-- „ÉÅ„É£„ÉÉ„Éà„É™„Çπ„Éà -->
                <div class="space-y-2">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-2">„ÉÅ„É£„ÉÉ„Éà</h3>
                    <div class="space-y-1">
                        <div
                            v-for="thread in chatThreads.filter(t => t.messages.length > 0)"
                            :key="thread.id"
                            @click="switchThread(thread.id)"
                            class="group flex items-center justify-between h-10 px-3 rounded-lg cursor-pointer transition-colors"
                            :class="currentThreadId === thread.id
                                ? 'bg-gradient-to-r from-[#22c55e]/10 to-[#06b6d4]/10 text-[#22c55e] font-medium'
                                : 'hover:bg-gray-100 text-gray-700'"
                        >
                            <span class="flex-1 truncate text-sm">{{ thread.name }}</span>
                            <!-- ÂâäÈô§„Éú„Çø„É≥ÔºàÁµ±‰∏Ä„Çµ„Ç§„Ç∫Ôºâ -->
                            <button
                                @click.stop="deleteThread(thread.id)"
                                title="ÂâäÈô§"
                                class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all rounded"
                            >
                                <span class="text-base leading-none">‚úï</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „ÉÅ„É£„ÉÉ„Éà„Éë„Éç„É´ -->
        <div
            class="fixed bottom-4 right-4 bg-white rounded-2xl shadow-2xl z-20 flex flex-col transition-all duration-300"
            :class="chatMinimized
                ? 'w-16 h-16'
                : 'w-[340px] sm:w-[380px] h-[45vh] sm:h-[480px]'"
        >
            <!-- ÊúÄÂ∞èÂåñÊôÇ„ÅÆUI -->
            <div v-if="chatMinimized" class="w-full h-full flex items-center justify-center">
                <button
                    @click="chatMinimized = false"
                    class="w-full h-full flex items-center justify-center bg-gradient-primary hover:bg-gradient-primary-dark text-white rounded-2xl transition-colors"
                >
                    <span class="text-2xl">üí¨</span>
                </button>
            </div>

            <!-- ÈÄöÂ∏∏ÊôÇ„ÅÆUI -->
            <template v-if="!chatMinimized">
                <!-- „ÉÅ„É£„ÉÉ„Éà„Éò„ÉÉ„ÉÄ„Éº -->
                <div class="h-14 bg-gradient-primary text-white px-4 flex items-center justify-between rounded-t-2xl shrink-0">
                    <h2 class="text-sm sm:text-base font-semibold truncate">{{ chatTitle }}</h2>
                    <div class="flex items-center gap-1">
                        <!-- ÊúÄÂ∞èÂåñ„Éú„Çø„É≥ -->
                        <button
                            @click="chatMinimized = true"
                            class="w-8 h-8 flex items-center justify-center hover:bg-white/20 rounded-lg transition-colors"
                            title="ÊúÄÂ∞èÂåñ"
                        >
                            <span class="text-lg leading-none">‚àí</span>
                        </button>
                    </div>
                </div>

                <!-- „Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥„Ç´„Éº„Éâ (ÂàùÊúüË°®Á§∫) -->
                <div v-if="messages.length === 0" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-3">
                    <div
                        v-for="suggestion in suggestions"
                        :key="suggestion.id"
                        @click="sendSuggestion(suggestion.text)"
                        class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-200 hover:border-primary hover:shadow-lg p-3 sm:p-4 rounded-xl cursor-pointer transition-all transform hover:scale-[1.02]"
                    >
                        <p class="text-xs sm:text-sm text-gray-700 leading-relaxed">{{ suggestion.text }}</p>
                    </div>
                </div>

                <!-- „É°„ÉÉ„Çª„Éº„Ç∏„É™„Çπ„Éà -->
                <div v-if="messages.length > 0" class="messages-container flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 sm:space-y-4">
                    <div
                        v-for="message in messages"
                        :key="message.id"
                        class="flex"
                        :class="message.role === 'user' ? 'justify-end' : 'justify-start'"
                    >
                        <div
                            class="max-w-[85%] rounded-2xl px-3 sm:px-4 py-2 sm:py-3 shadow-sm"
                            :class="message.role === 'user'
                                ? 'bg-gradient-primary text-white'
                                : 'bg-gray-100 text-gray-800'"
                        >
                            <!-- ÈÄöÂ∏∏„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ -->
                            <div v-if="!message.typing" v-html="formatMessage(message.content)" class="text-xs sm:text-sm leading-relaxed"></div>

                            <!-- „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÔºàÂàùÊúüÔºâ -->
                            <div v-if="message.typing && !message.content" class="flex items-center gap-2 py-1">
                                <div class="flex gap-1">
                                    <span class="typing-dot w-2 h-2 bg-current rounded-full"></span>
                                    <span class="typing-dot w-2 h-2 bg-current rounded-full"></span>
                                    <span class="typing-dot w-2 h-2 bg-current rounded-full"></span>
                                </div>
                                <span class="text-xs opacity-70">ÂõûÁ≠î„ÇíËÄÉ„Åà„Å¶„ÅÑ„Åæ„Åô</span>
                            </div>

                            <!-- „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞‰∏≠ -->
                            <div v-if="message.typing && message.content">
                                <div v-html="formatMessage(message.content)" class="text-xs sm:text-sm leading-relaxed mb-2"></div>
                                <div class="flex items-center gap-2 py-1">
                                    <div class="flex gap-1">
                                        <span class="typing-dot w-2 h-2 bg-current rounded-full"></span>
                                        <span class="typing-dot w-2 h-2 bg-current rounded-full"></span>
                                        <span class="typing-dot w-2 h-2 bg-current rounded-full"></span>
                                    </div>
                                    <span class="text-xs opacity-70">Âá¶ÁêÜ‰∏≠...</span>
                                </div>
                            </div>

                            <!-- POI„Ç´„Éº„ÉâË°®Á§∫ -->
                            <div v-if="message.pois && message.pois.length > 0" class="mt-2 sm:mt-3 space-y-2">
                                <div
                                    v-for="poi in message.pois"
                                    :key="poi.poi_id"
                                    @click="zoomToPoi(poi)"
                                    class="bg-white rounded-lg p-2 sm:p-3 cursor-pointer hover:shadow-md transition-all border"
                                    :class="selectedPoiId === (poi.poi_id || poi.id)
                                        ? 'border-[#22c55e] ring-2 ring-[#22c55e]/20'
                                        : 'border-gray-200 hover:border-[#06b6d4]'"
                                >
                                    <h4 class="font-semibold text-xs sm:text-sm text-gray-800 leading-tight">{{ poi.name }}</h4>
                                    <p v-if="poi.category" class="text-xs text-gray-500 mt-1">{{ poi.category }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                <div class="border-t border-gray-200 p-3 sm:p-4 bg-white rounded-b-2xl shrink-0">
                    <div class="flex gap-2">
                        <!-- „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢ -->
                        <textarea
                            v-model="inputMessage"
                            @keydown.enter="handleEnterKey"
                            @compositionstart="isComposing = true"
                            @compositionend="isComposing = false"
                            placeholder="AI„Å´Ë≥™Âïè„Åó„Å¶„ÅäÂ∫ó„ÇíÊé¢„Åó„Å¶„ÇÇ„Çâ„Åä„ÅÜ"
                            class="flex-1 h-10 sm:h-12 resize-none border border-gray-300 rounded-lg px-3 sm:px-4 py-2 sm:py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-xs sm:text-sm leading-tight"
                            rows="1"
                        ></textarea>
                        <!-- ÈÄÅ‰ø°„Éú„Çø„É≥Ôºàinput„Å®Âêå„ÅòÈ´ò„ÅïÔºâ -->
                        <button
                            @click="sendMessage"
                            :disabled="!inputMessage.trim()"
                            class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-gradient-primary hover:bg-gradient-primary-dark text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md"
                        >
                            <span class="text-lg sm:text-xl leading-none">‚û§</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- POIË©≥Á¥∞„Éë„Éç„É´ÔºàÁîªÈù¢‰∏ãÈÉ®„Åã„Çâ„Çπ„É©„Ç§„ÉâÔºâ -->
        <div
            v-if="selectedPoi"
            class="fixed inset-x-0 bottom-0 z-30 transform transition-transform duration-300"
            :class="selectedPoi ? 'translate-y-0' : 'translate-y-full'"
        >
            <!-- POIË©≥Á¥∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="bg-white rounded-t-3xl shadow-2xl max-h-[50vh] sm:max-h-[60vh] overflow-hidden flex flex-col">
                <!-- „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´ -->
                <div class="pt-2 pb-1 flex justify-center shrink-0">
                    <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
                </div>

                <!-- „É¢„Éº„ÉÄ„É´„Éò„ÉÉ„ÉÄ„Éº -->
                <div class="h-14 border-b border-gray-200 px-4 sm:px-6 flex items-center justify-between shrink-0">
                    <h2 class="text-base sm:text-lg font-bold text-gray-800 truncate pr-4">{{ selectedPoi.name || 'POIË©≥Á¥∞' }}</h2>
                    <!-- Èñâ„Åò„Çã„Éú„Çø„É≥ -->
                    <button
                        @click="closePoi"
                        class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors shrink-0"
                    >
                        <span class="text-2xl leading-none">‚úï</span>
                    </button>
                </div>

                <!-- „É¢„Éº„ÉÄ„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                <div class="flex-1 overflow-y-auto p-4 sm:p-6">
                    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
                    <div v-if="selectedPoi.loading" class="flex flex-col items-center justify-center py-12">
                        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                        <p class="mt-4 text-sm text-gray-600">Ë©≥Á¥∞ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>

                    <!-- „Ç®„É©„ÉºË°®Á§∫ -->
                    <div v-else-if="selectedPoi.error" class="bg-red-50 border border-red-200 rounded-lg p-4 text-sm text-red-700">
                        <p>{{ selectedPoi.error }}</p>
                    </div>

                    <!-- Ë©≥Á¥∞ÊÉÖÂ†±Ë°®Á§∫ -->
                    <div v-else class="space-y-4 sm:space-y-6 max-w-3xl mx-auto">

                        <!-- „Ç´„ÉÜ„Ç¥„É™„ÉºË°®Á§∫ -->
                        <div v-if="selectedPoi.category" class="text-sm text-gray-600">
                            <strong class="font-semibold">„Ç´„ÉÜ„Ç¥„É™„Éº:</strong> {{ selectedPoi.category }}
                        </div>

                        <!-- Ë™¨ÊòéÊñá -->
                        <div v-if="selectedPoi.description" class="text-sm text-gray-700 leading-relaxed">
                            {{ selectedPoi.description }}
                        </div>

                        <!-- Ë©≥Á¥∞ÊÉÖÂ†± -->
                        <div class="space-y-4">
                            <!-- ‰ΩèÊâÄ -->
                            <div v-if="selectedPoi.address" class="flex gap-3">
                                <span class="text-2xl leading-none shrink-0">üìç</span>
                                <div class="flex-1 min-w-0">
                                    <strong class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">‰ΩèÊâÄ</strong>
                                    <p class="text-sm text-gray-800">{{ selectedPoi.address }}</p>
                                </div>
                            </div>

                            <!-- ÈõªË©±Áï™Âè∑ -->
                            <div v-if="selectedPoi.phone || selectedPoi.contact?.phone" class="flex gap-3">
                                <span class="text-2xl leading-none shrink-0">üìû</span>
                                <div class="flex-1 min-w-0">
                                    <strong class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">ÈõªË©±Áï™Âè∑</strong>
                                    <a
                                        :href="'tel:' + (selectedPoi.phone || selectedPoi.contact.phone)"
                                        class="text-sm text-primary hover:underline"
                                    >
                                        {{ selectedPoi.phone || selectedPoi.contact.phone }}
                                    </a>
                                </div>
                            </div>

                            <!-- „Ç¶„Çß„Éñ„Çµ„Ç§„Éà -->
                            <div v-if="selectedPoi.website || selectedPoi.contact?.website" class="flex gap-3">
                                <span class="text-2xl leading-none shrink-0">üåê</span>
                                <div class="flex-1 min-w-0">
                                    <strong class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">„Ç¶„Çß„Éñ„Çµ„Ç§„Éà</strong>
                                    <a
                                        :href="selectedPoi.website || selectedPoi.contact.website"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="text-sm text-primary hover:underline break-all"
                                    >
                                        {{ selectedPoi.website || selectedPoi.contact.website }}
                                    </a>
                                </div>
                            </div>

                            <!-- „Ç´„Çπ„Çø„É†„Éï„Ç£„Éº„É´„Éâ -->
                            <template v-if="selectedPoi.custom_fields">
                                <div
                                    v-for="(value, key) in selectedPoi.custom_fields"
                                    :key="key"
                                    v-if="key !== 'Ë©ï‰æ°'"
                                    class="flex gap-3"
                                >
                                    <div class="flex-1 min-w-0">
                                        <strong class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">{{ key }}</strong>
                                        <p class="text-sm text-gray-800">{{ value }}</p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/map.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
